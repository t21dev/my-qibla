# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

My Qibla is a Progressive Web App (PWA) that helps Muslims find the Qibla (prayer direction) from anywhere in the world. Built with React 19 and Tailwind CSS v4.

## Commands

```bash
npm run dev      # Start development server (http://localhost:5173)
npm run build    # Type-check and build for production
npm run lint     # Run ESLint on all TypeScript/TSX files
npm run preview  # Preview production build locally
```

## Architecture

```
src/
├── components/
│   ├── ui/                    # Base reusable components (Box, Button, Card, Typography)
│   ├── compass/               # Compass component with smooth CSS animations
│   ├── permission/            # Permission request UI
│   ├── layout/                # Header and Footer
│   └── pwa/                   # PWA update prompt
├── hooks/
│   ├── useGeolocation.ts      # Location permission and caching
│   ├── useDeviceOrientation.ts # Compass heading with iOS 13+ and mobile detection
│   ├── useQibla.ts            # Combined hook for Qibla calculation
│   └── usePWA.ts              # Service worker registration and update handling
├── utils/
│   ├── qibla.ts               # Qibla direction calculation (spherical law of cosines)
│   └── cn.ts                  # Class name utility (clsx wrapper)
├── styles/
│   └── index.css              # Tailwind CSS v4 with custom theme
├── App.tsx                    # Main app with permission flow
├── main.tsx                   # Entry point
└── vite-env.d.ts              # Type declarations for virtual:pwa-register
```

## Tech Stack

- React 19 with React Compiler (Babel plugin)
- TypeScript with strict mode enabled
- Vite 7 for build and dev server
- Tailwind CSS v4 with @tailwindcss/vite plugin
- vite-plugin-pwa for offline support
- ESLint 9 (flat config) with TypeScript and React hooks plugins

## Design System

- **Colors**: Emerald (#10b981) for primary, Gold (#d4af37) for Qibla indicator
- **Typography**: Geist Sans font family (loaded from CDN)
- **Components**: Glass morphism effect using `glass` utility class

## Key Implementation Details

### Qibla Calculation (src/utils/qibla.ts)
- Kaaba coordinates: 21.4225°N, 39.8262°E
- Uses spherical law of cosines for bearing calculation
- Returns bearing in degrees (0-360, where 0 is North)

### Compass Animation (src/components/compass/Compass.tsx)
- CSS `transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1)`
- `will-change: transform` for GPU acceleration
- Shortest rotation path to prevent 360° jumps (uses normalizeAngle)

### Device Orientation (src/hooks/useDeviceOrientation.ts)
- iOS 13+: Uses `DeviceOrientationEvent.requestPermission()`
- Android: Uses `alpha` from deviceorientation event
- Smooth heading updates with interpolation (0.3 smoothing factor)
- Mobile detection: Detects if device has compass sensor
- Timeout detection: Shows error if no compass data received within 2 seconds

### PWA Service Worker (src/hooks/usePWA.ts)
- Uses `virtual:pwa-register` from vite-plugin-pwa
- Shows "App ready for offline use" prompt on first install
- Shows "New version available" prompt when updates are detected
- Checks for updates every hour
- `registerType: 'prompt'` - user controls when to update

## Testing

This app requires a mobile device with a compass sensor. Desktop browsers will show a warning message.

### Mobile Testing
1. Open the app on a mobile device
2. Click "Enable Compass"
3. Grant location and motion permissions
4. Point device toward Qibla

### Using agent-browser CLI
```bash
npm install -g agent-browser
agent-browser open http://localhost:5173
agent-browser snapshot -i    # See interactive elements
agent-browser click @e1      # Click Enable Compass
```

## TypeScript Configuration

The project uses project references with two configs:
- `tsconfig.app.json` - Application source (ES2022, strict, react-jsx)
- `tsconfig.node.json` - Build tooling (ES2023)

Strict settings are enabled including `noUnusedLocals`, `noUnusedParameters`, and `noFallthroughCasesInSwitch`.

## PWA Configuration

- **Service Worker**: Generated by Workbox via vite-plugin-pwa
- **Caching Strategy**: Precaches all static assets (JS, CSS, HTML, images)
- **Font Caching**: Runtime caching for Geist font from jsdelivr CDN (CacheFirst, 1 year)
- **Offline Support**: Works completely offline once loaded
- **Location Caching**: Last known location stored in localStorage
- **Dev Mode**: PWA enabled in development for testing (`devOptions.enabled: true`)
- **Update Flow**: Shows prompt when new version available, user clicks "Update" to reload
